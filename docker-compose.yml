version: '3.8'

services:
  # -------------------------------------------------------------------------
  # DATABASES
  # -------------------------------------------------------------------------
  db_auth:
    image: mysql:8.0
    container_name: db_auth
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: auth_db
    ports:
      - "3306:3306"
    volumes:
      - db_auth_data:/var/lib/mysql
    networks:
      - flow_network

  db_ecommerce:
    image: mysql:8.0
    container_name: db_ecommerce
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ecommerce_db
    ports:
      - "3307:3306"
    volumes:
      - db_ecommerce_data:/var/lib/mysql
    networks:
      - flow_network

  db_warehouse:
    image: mysql:8.0
    container_name: db_warehouse
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: warehouse_db
    ports:
      - "3308:3306"
    volumes:
      - db_warehouse_data:/var/lib/mysql
    networks:
      - flow_network

  db_shipping:
    image: mysql:8.0
    container_name: db_shipping
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: shipping_db
    ports:
      - "3309:3306"
    volumes:
      - db_shipping_data:/var/lib/mysql
    networks:
      - flow_network

  db_merchant:
    image: mysql:8.0
    container_name: db_merchant
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: merchant_db
    ports:
      - "3310:3306"
    volumes:
      - db_merchant_data:/var/lib/mysql
    networks:
      - flow_network

  db_notifications:
    image: mysql:8.0
    container_name: db_notifications
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: notifications_db
    ports:
      - "3311:3306"
    volumes:
      - db_notifications_data:/var/lib/mysql
    networks:
      - flow_network

  redis:
    image: redis:alpine
    container_name: flow_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - flow_network

  # -------------------------------------------------------------------------
  # API GATEWAY
  # -------------------------------------------------------------------------
  gateway:
    image: nginx:alpine
    container_name: flow_gateway
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth_service
      - ecommerce_service
      - warehouse_service
      - shipping_service
      - merchant_service
      - notifications_service
    networks:
      - flow_network

  # -------------------------------------------------------------------------
  # BACKEND SERVICES
  # -------------------------------------------------------------------------
  auth_service:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    container_name: auth_service
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - DB_HOST=db_auth
      - REDIS_HOST=redis
    depends_on:
      - db_auth
      - redis
    networks:
      - flow_network

  ecommerce_service:
    build:
      context: .
      dockerfile: services/ecommerce/Dockerfile
    container_name: ecommerce_service
    ports:
      - "4002:4002"
    environment:
      - PORT=4002
      - DB_HOST=db_ecommerce
      - REDIS_HOST=redis
    depends_on:
      - db_ecommerce
      - redis
    networks:
      - flow_network

  warehouse_service:
    build:
      context: .
      dockerfile: services/warehouse/Dockerfile
    container_name: warehouse_service
    ports:
      - "4003:4003"
    environment:
      - PORT=4003
      - DB_HOST=db_warehouse
      - REDIS_HOST=redis
    depends_on:
      - db_warehouse
      - redis
    networks:
      - flow_network

  shipping_service:
    build:
      context: .
      dockerfile: services/shipping/Dockerfile
    container_name: shipping_service
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
      - DB_HOST=db_shipping
      - REDIS_HOST=redis
    depends_on:
      - db_shipping
      - redis
    networks:
      - flow_network

  merchant_service:
    build:
      context: .
      dockerfile: services/merchant/Dockerfile
    container_name: merchant_service
    ports:
      - "4005:4005"
    environment:
      - PORT=4005
      - DB_HOST=db_merchant
      - REDIS_HOST=redis
    depends_on:
      - db_merchant
      - redis
    networks:
      - flow_network

  notifications_service:
    build:
      context: .
      dockerfile: services/notifications/Dockerfile
    container_name: notifications_service
    ports:
      - "4006:4006"
      - "4007:4007"
    environment:
      - PORT=4006
      - WS_PORT=4007
      - DB_HOST=db_notifications
      - REDIS_HOST=redis
    depends_on:
      - db_notifications
      - redis
    networks:
      - flow_network

networks:
  flow_network:
    driver: bridge

volumes:
  db_auth_data:
  db_ecommerce_data:
  db_warehouse_data:
  db_shipping_data:
  db_merchant_data:
  db_notifications_data:
  redis_data:
